try{if(!Nabu)throw"Nabu Manager not loaded"}catch(t){throw"Nabu Manager not loaded"}Nabu.Ajax=new Object,Nabu.Ajax.READY_STATE_UNINITIALIZED=0,Nabu.Ajax.READY_STATE_LOADING=1,Nabu.Ajax.READY_STATE_LOADED=2,Nabu.Ajax.READY_STATE_INTERACTIVE=3,Nabu.Ajax.READY_STATE_COMPLETE=4,Nabu.Ajax.GET="GET",Nabu.Ajax.POST="POST",Nabu.Ajax.PUT="PUT",Nabu.Ajax.DELETE="DELETE",Nabu.Ajax.basePath=null,Nabu.Ajax.Connector=function(t,e,s){this.url=t,this.method=e,this.request=null,this.params=s,this.pending=!1,this.postStream=null,this.start_time=null,this.request_type=null,this.events=new Nabu.EventPool;var r=document.location.protocol+"//"+document.location.host+(document.location.port>0?":"+document.location.port:"")+"/";if("/"!==this.url.substring(0,1)&&(this.url.length<r.length||this.url.substr(0,r.length)!==r)&&window.XDomainRequest)this.request=new XDomainRequest,this.request_type="XDomainRequest";else if(window.XMLHttpRequest)this.request=new XMLHttpRequest,this.request_type="XMLHttpRequest";else if(window.ActiveXObject){this.request=new ActiveXObject("Microsoft.XMLHTTP"),this.request_type="Microsoft.XMLHTTP";try{this.request=new ActiveXObject("MSXML2.XMLHTTP"),this.request_type="MSXML2.XMLHTTP"}catch(t){try{this.request=new ActiveXObject("Microsoft.XMLHTTP"),this.request_type="Microsoft.XMLHTTP"}catch(t){this.request_type=null}}}},Nabu.Ajax.Connector.prototype={isAjaxAllowed:function(){return null!==this.request},now:function(){return(new Date).getTime()},execute:function(){if(this.request)try{var t=this,e=this.params&&this.params.synchronous&&!0===this.params.synchronous;if(this.pending=!0,this.start_time=this.now(),"XDomainRequest"===this.request_type){e=!1;var s=nabu.getCookie("PHPSESSID");s.length>0&&(this.url.indexOf("?")<0?this.url=this.url+"?PHPSESSID="+s:this.url=this.url+"&PHPSESSID="+s),this.params.headerAccept&&"application/json"===this.params.headerAccept&&(this.url=this.url+"&json"),this.request.open(this.method,this.url),this.request.onprogress=function(){},this.request.ontimeout=function(){},this.request.onload=function(){t.onReadyState(),t.pending=!1},this.request.onerror=function(t){}}else if(this.request.open(this.method,this.url,!e),!e){this.request.onreadystatechange=function(){t.onReadyState(),t.pending=!1},this.request.ontimeout&&(this.request.ontimeout=function(){t.onTimeout(),t.pending=!1});try{this.request.upload.onprogress=function(e){t.onUploadProgress(e)}}catch(t){}}if(this.params&&(this.params.headerAccept&&this.setRequestHeader("Accept",this.params.headerAccept),this.params.headerCacheControl&&this.setRequestHeader("Cache-Control",this.params.headerCacheControl),this.params.headerAuthorization&&this.setRequestHeader("Authorization",this.params.headerAuthorization),this.params.withCredentials&&(this.request.withCredentials=this.params.withCredentials)),"POST"!==this.method&&"PUT"!==this.method&&"DELETE"!==this.method||(this.params&&void 0!==this.params.contentType?null!==this.params.contentType&&this.setRequestHeader("Content-Type",this.params.contentType):this.setRequestHeader("Content-Type","application/x-www-form-urlencoded")),"XDomainRequest"===this.request_type){var r=this.request;setTimeout(function(){r.send(t.postStream)},0)}else this.request.send(this.postStream),e&&this.onReadyState()}catch(t){this.params&&this.params.onError?this.params.onError(t):alert("Se ha producido un error. "+t)}},setRequestHeader:function(t,e){try{this.request.setRequestHeader(t,e)}catch(t){}},onReadyState:function(){var is_xdr="XDomainRequest"===this.request_type,is_synch=this.params&&this.params.synchronous&&!0===this.params.synchronous;if(is_xdr||is_synch||this.request.readyState===Nabu.Ajax.READY_STATE_COMPLETE){var httpStatus=is_xdr?200:this.request.status;if(200===httpStatus){this.params&&this.params.onLoad?this.params.onLoad(this.request.responseText):this.events.isEventTargeted("onLoad")||alert(this.request.responseText);var params=new Object;if(params.text=this.request.responseText,this.request.responseXML&&null!==this.request.responseXML)params.xml=this.request.responseXML;else try{var json=eval("("+this.request.responseText+")");null!==json&&(params.json=json)}catch(t){params.json=null}this.events.fireEvent("onLoad",this,params)}else this.events.isEventTargeted("onError")?this.events.fireEvent("onError",this,{message:"Error connecting to "+this.url}):console.log("Error connecting to "+this.url)}},onUploadProgress:function(t){var e=t.total,s=t.loaded,r=e-s,i=this.now()-this.start_time,a={lengthComputable:t.lengthComputable,total:t.total,loaded:t.loaded,current:i,timeleft:i*r/s,rate:1e3*s/i,ratio:0!==e?s/e:1};this.params&&this.params.onUploadProgress?this.params.onUploadProgress(a):this.events.isEventTargeted("onUploadProgress")&&this.events.fireEvent("onUploadProgress",this,a)},onTimeout:function(){alert("Timeout request")},abort:function(){this.pending&&this.request&&this.request.abort()},setPostJSON:function(t){this.postStream=JSON.stringify(t)},setPostStream:function(t){this.postStream=t},setPostParam:function(t,e){null!==this.postStream&&this.postStream.length>0?this.postStream+="&":this.postStream="",this.postStream+=encodeURIComponent(t)+"="+encodeURIComponent(e)},addEventListener:function(t){this.events.addEventListener(t)},removeEventListener:function(t){this.events.removeEventListener(t)}},nabu.registerLibrary("Ajax",["Event"]);