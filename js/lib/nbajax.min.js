try{if(!Nabu){throw"Nabu Manager not loaded"}}catch(e){throw"Nabu Manager not loaded"}Nabu.Ajax=new Object();Nabu.Ajax.READY_STATE_UNINITIALIZED=0;Nabu.Ajax.READY_STATE_LOADING=1;Nabu.Ajax.READY_STATE_LOADED=2;Nabu.Ajax.READY_STATE_INTERACTIVE=3;Nabu.Ajax.READY_STATE_COMPLETE=4;Nabu.Ajax.GET="GET";Nabu.Ajax.POST="POST";Nabu.Ajax.PUT="PUT";Nabu.Ajax.DELETE="DELETE";Nabu.Ajax.basePath=null;Nabu.Ajax.Connector=function(b,g,f){this.url=b;this.method=g;this.request=null;this.params=f;this.pending=false;this.postStream=null;this.start_time=null;this.request_type=null;this.events=new Nabu.EventPool();var c=document.location.protocol+"//"+document.location.host+(document.location.port>0?":"+document.location.port:"")+"/";var a=(this.url.substring(0,1)!=="/"&&(this.url.length<c.length||this.url.substr(0,c.length)!==c));if(a&&window.XDomainRequest){this.request=new XDomainRequest();this.request_type="XDomainRequest"}else{if(window.XMLHttpRequest){this.request=new XMLHttpRequest();this.request_type="XMLHttpRequest"}else{if(window.ActiveXObject){this.request=new ActiveXObject("Microsoft.XMLHTTP");this.request_type="Microsoft.XMLHTTP";try{this.request=new ActiveXObject("MSXML2.XMLHTTP");this.request_type="MSXML2.XMLHTTP"}catch(d){try{this.request=new ActiveXObject("Microsoft.XMLHTTP");this.request_type="Microsoft.XMLHTTP"}catch(d){this.request_type=null}}}}}};Nabu.Ajax.Connector.prototype={isAjaxAllowed:function(){return(this.request!==null)?true:false},now:function(){return new Date().getTime()},execute:function(){if(this.request){try{var a=this;var c=(this.params&&this.params.synchronous&&this.params.synchronous===true);this.pending=true;this.start_time=this.now();if(this.request_type==="XDomainRequest"){c=false;var g=nabu.getCookie("PHPSESSID");if(g.length>0){if(this.url.indexOf("?")<0){this.url=this.url+"?PHPSESSID="+g}else{this.url=this.url+"&PHPSESSID="+g}}if(this.params.headerAccept&&this.params.headerAccept==="application/json"){this.url=this.url+"&json"}this.request.open(this.method,this.url);this.request.onprogress=function(){};this.request.ontimeout=function(){};this.request.onload=function(){a.onReadyState();a.pending=false};this.request.onerror=function(h){}}else{this.request.open(this.method,this.url,!c);if(!c){this.request.onreadystatechange=function(){a.onReadyState();a.pending=false};if(this.request.ontimeout){this.request.ontimeout=function(){a.onTimeout();a.pending=false}}try{this.request.upload.onprogress=function(h){a.onUploadProgress(h)}}catch(f){}}}if(this.params){if(this.params.headerAccept){this.setRequestHeader("Accept",this.params.headerAccept)}if(this.params.headerCacheControl){this.setRequestHeader("Cache-Control",this.params.headerCacheControl)}if(this.params.headerAuthorization){this.setRequestHeader("Authorization",this.params.headerAuthorization)}if(this.params.withCredentials){this.request.withCredentials=this.params.withCredentials}}if(this.method==="POST"||this.method==="DELETE"){if(this.params&&(typeof this.params.contentType)!==(typeof undefined)){if(this.params.contentType!==null){this.setRequestHeader("Content-Type",this.params.contentType)}}else{this.setRequestHeader("Content-Type","application/x-www-form-urlencoded")}}if(this.request_type==="XDomainRequest"){var b=this.request;setTimeout(function(){b.send(a.postStream)},0)}else{this.request.send(this.postStream);if(c){this.onReadyState()}}}catch(d){if(this.params&&this.params.onError){this.params.onError(d)}else{alert("Se ha producido un error. "+d)}}}},setRequestHeader:function(a,b){try{this.request.setRequestHeader(a,b)}catch(c){}},onReadyState:function(){var is_xdr=this.request_type==="XDomainRequest";var is_synch=(this.params&&this.params.synchronous&&this.params.synchronous===true);if(is_xdr||is_synch||this.request.readyState===Nabu.Ajax.READY_STATE_COMPLETE){var httpStatus=(is_xdr?200:this.request.status);if(httpStatus===200){if(this.params&&this.params.onLoad){this.params.onLoad(this.request.responseText)}else{if(!this.events.isEventTargeted("onLoad")){alert(this.request.responseText)}}var params=new Object();params.text=this.request.responseText;if(this.request.responseXML&&this.request.responseXML!==null){params.xml=this.request.responseXML}else{try{var json=eval("("+this.request.responseText+")");if(json!==null){params.json=json}}catch(e){params.json=null}}this.events.fireEvent("onLoad",this,params)}else{if(this.events.isEventTargeted("onError")){this.events.fireEvent("onError",this,{message:"Error connecting to "+this.url})}else{console.log("Error connecting to "+this.url)}}}},onUploadProgress:function(c){var b=c.total;var a=c.loaded;var g=b-a;var d=this.now()-this.start_time;var f={lengthComputable:c.lengthComputable,total:c.total,loaded:c.loaded,current:d,timeleft:(d*g)/a,rate:a*1000/d,ratio:(b!==0?a/b:1)};if(this.params&&this.params.onUploadProgress){this.params.onUploadProgress(f)}else{if(this.events.isEventTargeted("onUploadProgress")){this.events.fireEvent("onUploadProgress",this,f)}}},onTimeout:function(){alert("Timeout request")},abort:function(){if(this.pending&&this.request){this.request.abort()}},setPostJSON:function(a){this.postStream=JSON.stringify(a)},setPostStream:function(a){this.postStream=a},setPostParam:function(a,b){if(this.postStream!==null&&this.postStream.length>0){this.postStream+="&"}else{this.postStream=""}this.postStream+=encodeURIComponent(a)+"="+encodeURIComponent(b)},addEventListener:function(a){this.events.addEventListener(a)},removeEventListener:function(a){this.events.removeEventListener(a)}};nabu.registerLibrary("Ajax",["Event"]);