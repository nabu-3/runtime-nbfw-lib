try{if(!Nabu){throw"Nabu Manager not loaded"}}catch(e){throw"Nabu Manager not loaded"}if(typeof Nabu.UI==="undefined"){Nabu.UI=function(){}}Nabu.UI.Tree=function(a,c){this.events=new Nabu.EventPool();this.container=a;this.params=c;try{this.tree=$(a).find(".tree").get(0)}catch(b){this.tree=null}this.init()};Nabu.UI.Tree.prototype={addEventListener:function(a){this.events.addEventListener(a)},removeEventListener:function(a){this.events.removeEventListener(a)},init:function(){this.initEditButtonStyle();this.initCollapseButtons(this.container);this.initToolbar();this.initDAD()},initEditButtonStyle:function(){var a=this;if(this.params.editButton==="button"){$(this.container).find(".btn-editor").on("click",function(b){return a.doEditButtonClick(b)})}else{if(this.params.editButton==="line"){$(this.container).find(".tree-level > li > .tree-item").on("click",function(b){return a.doEditButtonClick(b)})}}},initCollapseButtons:function(a){var b=this;$(a).find(".tree-item-toolbar > .btn-expand").on("click",function(d){d.stopPropagation();var c=$(this).closest(".tree-item");b.toggleCollapsedItem(c);return false})},initToolbar:function(){var a=this;$(this.container).find(".tree-toolbar .btn").on("click",function(c){var b=$(this).data();if(b.action){a.events.fireEvent("onToolbarClick",a,{action:b.action,selection:a.getSelectedItems()})}if(!b.toggle){c.preventDefault();return false}else{return true}});this.enableToolbarButtons()},initDAD:function(){$(this.container).find('[data-toggle="drag-item"]').on("nabu.DAD.beforeDragStart",function(){console.log("nabu.DAD.beforeDragStart");return true})},enableToolbarButtons:function(){var b=$(this.container).find(".tree-toolbar");if(b.length>0){var a=this.getSelectedItems();b.find(".btn").attr("disabled","disabled");if(a!==null){if(a.length===1){b.find('[data-apply="all"], [data-apply="single"], [data-apply="multiple"]').removeAttr("disabled")}else{if(a.length>1){b.find('[data-apply="all"], [data-apply="multiple"]').removeAttr("disabled")}}}else{b.find('[data-apply="all"]').removeAttr("disabled")}}},toggleCollapsedItem:function(b){var a=$(b).closest("li");a.toggleClass("expanded");var c=$(b).data();this.events.fireEvent("onToggle",this,{id:(typeof c.id==="undefined")?null:c.id,expanded:a.hasClass("expanded")})},doEditButtonClick:function(a){var b=false;if(this.params.editButton==="line"){b=$(a.currentTarget).data("id")}else{if(this.params.editButton==="button"){b=$(a.currentTarget).closest("[data-id]").data("id")}else{throw Exception("Invalid editButton value ["+b+"]")}}this.editor(b)},editor:function(i){if(typeof this.params.editor!=="string"||this.params.editor.length===0){console.log("Invalid editor Ajax URL");return}var h=this;var g=((typeof i)==="undefined");var f=g?$.sprintf(this.params.editor,""):$.sprintf(this.params.editor,i);if(this.params.editorMode==="ajax"&&this.params.editorContainer.length>0){if(g){var b="new_"+(new Date().getTime())+""+Math.floor(Math.random()*900)+100}else{this.editItem(i)}var a=$("#"+this.params.editorContainer);if(a.length>0){a.find('[id^="'+this.params.editorContainer+'_"]').addClass("hide")}var c=a.find(".myst");c.removeClass("hide");var d=g?[]:a.find('[id="'+this.params.editorContainer+"_"+i+'"]');if(d.length>0){d.removeClass("hide");c.addClass("hide");$(this.tree).find(".tree-level > li > .tree-item").removeClass("editing");$(this.tree).find('.tree-level > li > .tree-item[data-id="'+i+'"]').addClass("editing")}else{nabu.loadLibrary("Ajax",function(){var j=new Nabu.Ajax.Connector(f,"GET");j.addEventListener(new Nabu.Event({onLoad:function(m){var k=h.params.editorContainer+"_"+(g?b:i);var n=document.createElement("DIV");n.id=k;n.innerHTML=m.params.text;a.append(n);if(g){var l=a.find("form[data-multiform-part]");l.each(function(){var o=$(this).data("multiform-part");$(this).attr("data-multiform-part",$.sprintf(o,b));$(this).data("multiform-part",$.sprintf(o,b))})}$(h.tree).find(".tree-level > li > .tree-item").removeClass("editing");$(h.tree).find('.tree-level > li > .tree-item[data-id="'+(g?b:i)+'"]').addClass("editing");h.events.fireEvent("onLoadEditor",h,{id:(g?b:i),container_id:k});c.addClass("hide")},onError:function(k){c.addClass("hide")}}));j.execute()})}}else{if(this.params.editorMode==="page"){document.location=f}}return false},getSelectedItems:function(){var a=[];$(this.container).find(".tree-level > li > .tree-item.active").each(function(b){if($(this).data("id")){a.push($(this).data("id"))}});return a.length>0?a:null},editItem:function(b){if(this.tree!==null){var c=$(this.tree).find('.tree-level > li > .tree-item[data-id="'+b+'"]');var a=c.find(".tree-item-flags");if(a.find(".edited").length===0){$('<i class="fa fa-pencil text-danger edited pull-left"></i>').appendTo(a)}}},connectForm:function(d,a){var b=$(a);if(b.length===1){var c=b.get(0);if(c.nabuForm){var f=this;c.nabuForm.addEventListener(new Nabu.Event({onFieldChange:function(g,h){}}))}else{console.log("Nabu.Form object not found")}}else{console.log("More than one forms found with same identifier")}}};nabu.registerLibrary("Tree",["Event"]);