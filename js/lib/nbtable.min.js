try{if(!Nabu)throw"Nabu Manager not loaded"}catch(t){throw"Nabu Manager not loaded"}void 0===Nabu.UI&&(Nabu.UI=function(){}),Nabu.UI.Table=function(t,e){this.events=new Nabu.EventPool,this.container=t,this.params=e,this.currentPage=1;try{this.table=$(t).find("table").get(0)}catch(t){this.table=null}this.init()},Nabu.UI.Table.prototype={addEventListener:function(t){this.events.addEventListener(t)},removeEventListener:function(t){this.events.removeEventListener(t)},init:function(){this.initUI(),this.initPager(),this.initEditButtonStyle(),this.initSelectableCheckbox(),this.initToolbar()},initUI:function(){var t=this;$(window).resize(function(){var e=$(t.container).find('tbody tr[data-type="row"]:first').children().map(function(){return $(this).width()}).get();$(t.container).find("thead tr").children().each(function(t,a){$(a).width(e[t])})}).resize()},initPager:function(){var t=this;if($(this.container).find(".table-pager").remove(),this.params.tablePager&&this.params.tableSize>0){var e=$(this.container).find('tbody > tr:not([data-type="empty"])'),a=Math.ceil(e.length/this.params.tableSize),i=this.currentPage>2?this.currentPage-2:1,n=i+4>a?a:i+4;if(i=n-i<5?n>4?n-4:1:i,a>1){for(var r='<div class="table-pager"><nav aria-label="Page navigation"><ul class="pagination"><li'+(1===this.currentPage?' class="disabled"':"")+'><a href="#" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a></li>',l=i;l<=n;l++)r+="<li"+(l===this.currentPage?' class="active"':"")+' data-page="'+l+'"><a href="#">'+l+"</a></li>";r+="<li"+(this.currentPage===a?' class="disabled"':"")+'><a href="#" aria-label="Next"><span aria-hidden="true">&raquo;</span></a></li></ul></nav></div>',$(this.container).append(r),pager=$(this.container).find(".table-pager"),this.currentPage>1&&pager.find("li:first-child > a").on("click",function(e){e.preventDefault(),t.currentPage>1&&(t.currentPage--,t.initPager())}),this.currentPage<a&&pager.find("li:last-child > a").on("click",function(e){e.preventDefault(),t.currentPage<a&&(t.currentPage++,t.initPager())}),pager.find("li[data-page]").on("click",function(e){e.preventDefault(),t.currentPage=$(this).data("page"),t.initPager()});for(var l=0;l<e.length;l++){Math.ceil((l+1)/this.params.tableSize)===this.currentPage?$(e[l]).removeClass("hide"):$(e[l]).addClass("hide")}}else e.removeAttr("hide")}},initEditButtonStyle:function(){var t=this;"button"===this.params.editButton?$(this.container).find(".btn-editor").unbind("click").on("click",function(e){return t.doEditButtonClick(e)}):"line"===this.params.editButton&&$(this.container).find("tr[data-id]").unbind("click").on("click",function(e){return t.doEditButtonClick(e)})},initSelectableCheckbox:function(){var t=this;$(this.container).find('thead th[data-toggle="table-selectable"] input[type="checkbox"]').unbind("click").on("click",function(e){return t.doSelectableHeadCheckbox(e)}),$(this.container).find('tbody td[data-toggle="table-selectable"] input[type="checkbox"]').unbind("click").on("click",function(e){return t.doSelectableBodyCheckbox(e)})},initToolbar:function(){var t=this;$(this.container).find(".table-toolbar .btn").on("click",function(e){var a=$(this).data();if(a.action&&t.events.fireEvent("onToolbarClick",t,{action:a.action,selection:t.getSelectedItems()}),a.toggle)return!0;if("a"===this.tagName.toLowerCase()){var i=t.getSelectedItems();if(1===i.length&&a.href)return $(this).attr("href",$.sprintf(a.href,i[0])),!0}return e.preventDefault(),!1}),this.enableToolbarButtons()},enableToolbarButtons:function(){var t=$(this.container).find(".table-toolbar");if(t.length>0){var e=this.getSelectedItems();t.find(".btn").attr("disabled","disabled"),null!==e?1===e.length?t.find('[data-apply="all"], [data-apply="single"], [data-apply="multiple"]').removeAttr("disabled"):e.length>1&&t.find('[data-apply="all"], [data-apply="multiple"]').removeAttr("disabled"):t.find('[data-apply="all"]').removeAttr("disabled")}},doEditButtonClick:function(t){var e=!1;if("line"===this.params.editButton)e=$(t.currentTarget).data("id");else{if("button"!==this.params.editButton)throw Exception("Invalid editButton value ["+e+"]");e=$(t.currentTarget).closest("[data-id]").data("id")}this.editor(e)},editor:function(t,e){var a=this,i=void 0===t,e=void 0!==e&&e,n=i?$.sprintf(this.params.editor,""):$.sprintf(this.params.editor,t);if(e&&(n+=(n.indexOf("?")>=0?"&":"?")+"clone"),"ajax"===this.params.editorMode&&this.params.editorContainer.length>0){if(i){var r="new_"+(new Date).getTime()+Math.floor(900*Math.random())+100;this.hideEmptyMessage(),this.appendRow(r),this.initSelectableCheckbox(),this.initEditButtonStyle()}else this.editRow(t);var l=$("#"+this.params.editorContainer);l.length>0&&l.find("[id^="+this.params.editorContainer+"_]").addClass("hide");var d=l.find(".myst");d.removeClass("hide");var o=i?[]:l.find("[id="+this.params.editorContainer+"_"+t+"]");if(o.length>0){var s=a.params.editorContainer+"_"+(i?r:t);o.removeClass("hide"),d.addClass("hide"),$(this.table).find("tr").removeClass("editing"),$(this.table).find('tr[data-id="'+t+'"]').addClass("editing"),a.events.fireEvent("onShownEditor",a,{id:i?r:t,container_id:s})}else nabu.loadLibrary("Ajax",function(){var e=new Nabu.Ajax.Connector(n,"GET");e.addEventListener(new Nabu.Event({onLoad:function(e){var n=a.params.editorContainer+"_"+(i?r:t),o=document.createElement("DIV");if(o.id=n,o.innerHTML=e.params.text,l.append(o),i){l.find("form[data-multiform-part]").each(function(){var t=$(this).data("multiform-part");$(this).attr("data-multiform-part",$.sprintf(t,r)),$(this).data("multiform-part",$.sprintf(t,r))})}$(a.table).find("tr").removeClass("editing"),$(a.table).find('tr[data-id="'+(i?r:t)+'"]').addClass("editing"),a.events.fireEvent("onLoadEditor",a,{id:i?r:t,container_id:n}),d.addClass("hide")},onError:function(t){d.addClass("hide")}})),e.execute()})}else"page"===this.params.editorMode&&(document.location=n);return!1},appendRow:function(t){if(null!==this.table){var e=this.table.insertRow(this.table.rows.length);if($(e).attr("data-id",t),"line"===this.params.editButton&&$(e).addClass("btn-edit-line"),this.table.tHead.rows.length>0)for(var a=this.table.tHead.rows[0],i=0;i<a.cells.length;i++){var n=a.cells[i],r=e.insertCell();n.hasAttribute("data-toggle")&&"table-selectable"===n.getAttribute("data-toggle")&&(r.setAttribute("data-toggle","table-selectable"),r.innerHTML='<input type="checkbox">'),n.hasAttribute("class")&&r.setAttribute("class",n.getAttribute("class")),n.hasAttribute("data-name")&&r.setAttribute("data-name",n.getAttribute("data-name")),n.hasAttribute("data-align")&&$(r).addClass(n.getAttribute("data-align")),n.hasAttribute("data-is-id")&&"true"===n.getAttribute("data-is-id")&&$(r).html('<i class="fa fa-plus text-danger edited pull-left"></i>')}}},editRow:function(t){if(null!==this.table){var e=$(this.table).find('tbody tr[data-id="'+t+'"]').get(0),a=this.table.tHead.rows[0];if(e.cells.length===a.cells.length)for(var i=0;i<a.cells.length;i++){var n=a.cells[i];if($(n).data("is-id")){var r=e.cells[i];0===$(r).find(".edited").length&&$('<i class="fa fa-pencil text-danger edited pull-left"></i>').insertBefore($(r).children().get(0))}}}},getCell:function(t,e){return null!==this.table?$(this.table).find('tbody tr[data-id="'+t+'"] td[data-name="'+e+'"]').html():null},doSelectableHeadCheckbox:function(t){t.stopPropagation();var e=$(this.container).find('tbody td[data-toggle="table-selectable"] input[type="checkbox"]');$(t.currentTarget);return t.currentTarget.checked?e.prop("checked",!0):e.prop("checked",!1),this.enableToolbarButtons(),!0},doSelectableBodyCheckbox:function(t){t.stopPropagation();var e=$(this.container).find('thead th[data-toggle="table-selectable"] input[type="checkbox"]'),a=$(this.container).find('tbody td[data-toggle="table-selectable"] input[type="checkbox"]').length,i=$(this.container).find('tbody td[data-toggle="table-selectable"] input[type="checkbox"]:checked').length;return e.prop("checked",a===i),this.enableToolbarButtons(),!0},getSelectedItems:function(){var t=[];return $(this.container).find('tbody td[data-toggle="table-selectable"] input[type="checkbox"]:checked').closest("tr").each(function(e){$(this).data("id")&&t.push($(this).data("id"))}),t.length>0?t:null},connectForm:function(t,e){var a=$(e);if(1===a.length){var i=a.get(0);if(i.nabuForm){var n=this;i.nabuForm.addEventListener(new Nabu.Event({onFieldChange:function(e,a){var i=$(n.table).find('thead th[data-name="'+e.params.field+'"]');if(1===i.length){var r=e.params.value,l=i.data("lookup");void 0!==l&&(r=l[e.params.value]),$(n.table).find('tbody tr[data-id="'+t+'"] td[data-name="'+e.params.field+'"]').text(r)}}}))}else console.log("Nabu.Form object not found")}else a.length>1&&console.log("More than one forms found with same identifier ["+e+"]")},hideEmptyMessage:function(){$(this.container).find('tbody > tr[data-type="empty"]').addClass("hide")}},nabu.registerLibrary("Table",["Event","Ajax"]);