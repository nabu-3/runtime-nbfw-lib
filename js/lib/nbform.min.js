try{if(!Nabu){throw"Nabu Manager not loaded"}}catch(e){throw"Nabu Manager not loaded"}if(typeof Nabu.UI==="undefined"){Nabu.UI=function(){}}Nabu.UI.Form=function(a,b){this.events=new Nabu.EventPool();this.container=a;this.params=b;this.form=null;this.fields=new Array();this.formaction=null;this.maskActions={id:null,name:null};this.submit_object=null;this.validate=true;this.init()};Nabu.UI.Form.prototype={addEventListener:function(a){this.events.addEventListener(a)},removeEventListener:function(a){this.events.removeEventListener(a)},init:function(a){var c=this;var b=null;if(this.container.tagName==="FORM"){b=this.container}else{if($(this.container).find("form").length>0){b=$(this.container).find("form").get(0)}else{if($(this.container).closest("form").length>0){b=$(this.container).closest("form").get(0)}}}if(typeof a==="undefined"){a=false}if(b){this.form=b;b.nabuForm=this;if(!a){$(b).on("submit",function(d){return c.onSubmit(d.originalEvent)})}this.locateFields(a);this.validateForm();if(!a){setTimeout(function(){c.init(true)},1000)}}},locateFields:function(c){for(var g in this.form.elements){var b=null;if(g!=="attributes"&&g!=="elements"&&g!=="childNodes"&&g!=="children"&&g!=="properties"&&g!=="all"){var d=this.form[g];if(d!==null&&d!==""&&d!==true&&typeof d==="object"&&(d instanceof Element||d instanceof NodeList||d instanceof HTMLCollection)){if(d instanceof HTMLInputElement||d instanceof HTMLSelectElement||d instanceof HTMLTextAreaElement){b=d}else{if(d instanceof HTMLButtonElement){b=d}else{if(d instanceof NodeList){b=d}else{if(d instanceof HTMLCollection){b=d}}}}if(b!==null){var a=(d.name&&d.name.length>0?d.name:g);if(c!==true){d.nabuForm=false}this.appendField(a,d)}}}}},appendField:function(g,d){var b,c=false;if(d instanceof NodeList){for(b=0;b<d.length;b++){if(!d.nabuForm){this.connectFieldObject(d[b]);c=true}}}else{if(d instanceof HTMLCollection){for(b=0;b<d.length;b++){if(!d.nabuForm){this.connectFieldObject(d.item(b));c=true}}}else{if(!d.nabuForm){this.connectFieldObject(d);c=true}}}if(c===true){if(this.fields[g]){if(this.fields[g].object instanceof Array){if(this.fields[g].object.indexOf(d)<0){this.fields[g].object.push(d)}}else{if(this.fields[g].object!==d){this.fields[g].object=[this.fields[g].object];if(this.fields[g].object.indexOf(d)<0){this.fields[g].object.push(d)}}}}else{this.fields[g]={object:d,trigger:3,actions:null,touched:false,visible:true,enabled:true}}if(!(d instanceof HTMLButtonElement)&&!(d instanceof HTMLInputElement&&(d.type==="button"||d.type==="submit"||d.type==="image"||d.type==="hidden"))){var a=this.validateField(g);this.setFieldStatusClass(g,a)}this.resetActionsFlag();this.applyActionsForField(g);this.validateSameFields(g);this.validateForm()}},connectFieldObject:function(b){var c=this;b.nabuForm=this;if(b instanceof HTMLSelectElement){$(b).on("change",function(d){return c.onChangeField(d.originalEvent)})}else{if(b instanceof HTMLInputElement){var a=b.type.toLowerCase();switch(a){case"text":case"number":case"date":case"time":case"datetime":case"email":case"password":case"file":$(b).on("change",function(d){return c.onChangeField(d.originalEvent?d.originalEvent:d)}).on("blur",function(d){return c.onBlurField(d.originalEvent?d.originalEvent:d)}).on("focus",function(d){return c.onFocusField(d.originalEvent?d.originalEvent:d)});this.applyPlaceholder(b,false);break;case"button":case"submit":case"image":case"checkbox":$(b).on("click",function(d){return c.onClickField(d.originalEvent?d.originalEvent:d)});break;case"radio":$(b).on("click",function(d){return c.onClickField(d.originalEvent?d.originalEvent:d)});if(b.checked){$(b.parentElement).addClass(this.active_class)}break;case"hidden":$(b).on("change",function(d){return c.onChangeField(d.originalEvent?d.originalEvent:d)});break;default:$(b).on("blur",function(d){return c.onBlurField(d.originalEvent?d.originalEvent:d)})}if(this.params.validation==="live"){$(b).on("keyup",function(d){return c.onKeyUp(d.originalEvent?d.originalEvent:d)})}}else{if(b instanceof HTMLTextAreaElement){$(b).on("change",function(d){return c.onChangeField(d.originalEvent?d.originalEvent:d)}).on("blur",function(d){return c.onBlurField(d.originalEvent?d.originalEvent:d)}).on("focus",function(d){return c.onFocusField(d.originalEvent?d.originalEvent:d)});if(this.params.validation==="live"){$(b).on("keyup",function(d){return c.onKeyUp(d.originalEvent?d.originalEvent:d)})}}else{if(b instanceof HTMLButtonElement){$(b).on("click",function(d){return c.onClickField(d.originalEvent?d.originalEvent:d)})}else{$(b).on("blur",function(d){return c.onBlurField(d.originalEvent?d.originalEvent:d)})}}}}},isAvailableField:function(a){var d=(this.params.evaluate==="visible"?false:true);if(this.fields[a]){if(this.fields[a].object instanceof NodeList||this.fields[a].object instanceof Array){for(var c in this.fields[a].object){d=d||nabu.isObjectVisible(this.fields[a].object[c].parentElement)}}else{if(this.fields[a].object instanceof HTMLCollection){for(var b=0;b<this.fields[a].object.length;b++){d=d||nabu.isObjectVisible(this.fields[a].object.item(b).parentElement)}}else{d=d||nabu.isObjectVisible(this.fields[a].object.parentElement)}}}return d},getFieldValue:function(a){var c=null;if(this.fields[a]){var d=this.fields[a];if(d.object instanceof NodeList||d.object instanceof Array){c=new Array();for(var b=0;b<d.object.length;b++){if(d.object[b].checked||d.object[b].selected){c.push(d.object[b].value)}}if(c.length===0){c=null}else{if(c.length===1){c=c.shift()}}}else{if(d.object instanceof HTMLCollection){c=new Array();for(var b=0;b<d.object.length;b++){if(d.object.item(b).checked||d.object.item(b).selected){c.push(d.object.item(b).value)}}if(c.length===0){c=null}else{if(c.length===1){c=c.shift()}}}else{if(d.object instanceof HTMLSelectElement){if(d.object.selectedIndex>-1){c=d.object[d.object.selectedIndex].value}}else{if(d.object instanceof HTMLInputElement||d.object instanceof HTMLTextAreaElement){if(d.object.attributes.type&&d.object.attributes.type.value==="radio"&&d.object.attributes.name&&this.form!==null){c=this.getRadioValue(this.form[d.object.attributes.name.value],null)}else{if(d.object.attributes.type&&d.object.attributes.type.value==="checkbox"&&!d.object.checked){c=$(d.object).data("valueUnchecked")}else{c=d.object.value}}if(nabu.getNavigatorName()==="MSIE"&&d.object.attributes.placeholder&&d.object.attributes.placeholder===c){c=""}}}}}}return c},getRadioValue:function(b,a){for(i=0;i<b.length;i++){if(b[i].checked){return b[i].value}}return a},evaluateField:function(b,c){var a=true;if(this.fields[b]){a=this.validateField(b,c);this.setFieldStatusClass(b,a);this.resetActionsFlag();this.applyActionsForField(b);this.validateSameFields(b);this.validateForm();if(a===0){a=false}}return true},fieldFollowsForm:function(c,b,a){if(c===null){return true}switch(b){case"active":this.applyMask(c,{enabled:a,visible:null});break;case"visible":this.applyMask(c,{enabled:null,visible:a});break;default:throw"Unknown data-form-follow type ["+b+"]"}return true},validateField:function(c,h){var b=3;if(typeof h==="undefined"){h=false}if(this.fields[c]){if(h===false){if(this.fields[c].object instanceof NodeList||this.fields[c].object instanceof Array){b=0;for(var d=0;d<this.fields[c].object.length;d++){var g=this.fields[c].object[d];var a=this.validateFieldPart(g);if(a>b){b=a}}}else{if(this.fields[c].object instanceof HTMLCollection){b=0;for(var d=0;d<this.fields[c].object.length;d++){var g=this.fields[c].object.item(d);var a=this.validateFieldPart(g);if(a>b){b=a}}}else{var g=this.fields[c].object;b=this.validateFieldPart(g)}}b=this.events.fireEvent("onValidateField",this,{name:c,status:b},b)}else{b=this.events.fireEvent("onValidateField",this,{name:c,status:h},b)}this.fields[c].trigger=b}return b},validateFieldPart:function(l){var c=this;var b=3;var g=(l.attributes&&l.attributes["data-form-mandatory"]?l.attributes["data-form-mandatory"].value:"none");var k=(l.attributes&&l.attributes["data-form-rule"]?l.attributes["data-form-rule"].value:"none");var a=(l.attributes&&l.attributes["data-form-rule-param"]?l.attributes["data-form-rule-param"].value:null);var m=l.value;if(nabu.getNavigatorName()==="MSIE"&&l.attributes.placeholder&&l.attributes.placeholder.value===m){m=""}if(k!=="none"){if(g==="yes"){b=0}else{b=(m.length===0?1:0)}var d=k.split(":");var j=d===null?k:d[0];switch(j){case"filled":if(m.length>0&&(!l.attributes["data-unselected-value"]||l.attributes["data-unselected-value"].value!==m)){b=2}break;case"regex":if(m.length>0){d=RegExp("("+a+")").exec(m);if(d!==null&&d.length>=2&&d[1].length===m.length){b=2}}break;case"uri":if(d.length===2){switch(d[1]){case"web":if(nabu.isValidURL(m)){b=2}break;case"email":if(nabu.isValidEmail(m)){b=2}break;case"ipv4":if(nabu.isValidIPv4(m)){b=2}break;case"phone":if(nabu.isValidPhoneNumber(m)){b=2}break}}break;case"same":if(d.length===2){var h=this.getFieldValue(d[1]);if((h===null||h===false||h==="")&&(m===null||m===false||m==="")){b=(g==="yes"?0:1)}else{if(h===m){b=2}else{b=0}}}break;case"checked":if(!(l instanceof NodeList)&&!(l instanceof HTMLCollection)&&!(l instanceof Array)&&l.checked&&l.checked===true){b=2}break;case"unchecked":if(!(l instanceof NodeList)&&!(l instanceof HTMLCollection)&&!(l instanceof Array)&&l.checked&&l.checked!==true){b=2}break;case"groupcheck":if(l instanceof HTMLInputElement&&l.attributes.type.value=="checkbox"&&d.length===3){if($('[data-form-rule="'+k+'"]:checked').length>=d[2]){b=2}else{b=0}l.formValidationLock=true;$('[data-form-rule="'+k+'"]').each(function(){if(!this.formValidationLock){c.evaluateField(this.attributes.name.value,b)}});l.formValidationLock=false;console.log("Hola "+b)}break}}return b},validateSameFields:function(a){var h,c;for(var b in this.fields){if(b!==a){h=this.fields[b];var g=(h.object.attributes&&h.object.attributes["data-form-rule"]?h.object.attributes["data-form-rule"].value:"none");if(g!==null&&g!=="none"){var d=g.split(":");if(d!==null&&d.length===2&&d[0]==="same"&&d[1]===a){this.evaluateField(b)}}}}},validateForm:function(){if(this.fields!==null){this.validate=true;for(var a in this.fields){field=this.fields[a];if(field.trigger===0){if(field.object instanceof NodeList||field.object instanceof Array){for(i=0;i<field.object.length;i++){if(this.isAvailableField(a)&&!field.object[i].disabled){this.validate=false}}}else{if(field.object instanceof HTMLCollection){for(i=0;i<field.object.length;i++){if(this.isAvailableField(a)&&!field.object.item(i).disabled){this.validate=false}}}else{if(this.isAvailableField(a)&&!field.object.disabled){this.validate=false}}}}}for(var a in this.fields){field=this.fields[a];if(field.object instanceof NodeList||field.object instanceof Array){for(i=0;i<field.object.length;i++){if(field.object[i].attributes&&field.object[i].attributes!==null&&field.object[i].attributes["data-form-follow"]&&this.isAvailableField(a)){this.fieldFollowsForm(field.object[i],field.object[i].attributes["data-form-follow"].value,this.validate)}}}else{if(field.object instanceof HTMLCollection){for(i=0;i<field.object.length;i++){if(field.object.item(i).attributes&&field.object.item(i).attributes!==null&&field.object.item(i).attributes["data-form-follow"]&&this.isAvailableField(a)){this.fieldFollowsForm(field.object.item(i),field.object.item(i).attributes["data-form-follow"].value,this.validate)}}}else{if(field.object.attributes!==null&&field.object.attributes["data-form-follow"]&&this.isAvailableField(a)){this.fieldFollowsForm(field.object,field.object.attributes["data-form-follow"].value,this.validate)}}}}return this.validate}return false},setFieldStatusClass:function(b,a){if(this.fields[b]){if(this.fields[b].object instanceof NodeList||this.fields[b].object instanceof Array){for(var c=0;c<this.fields[b].object.length;c++){var d=this.fields[b].object[c];this.setFieldStatusClassInternal(d,a)}}else{if(this.fields[b].object instanceof HTMLCollection){for(var c=0;c<this.fields[b].object.length;c++){var d=this.fields[b].object.item(c);this.setFieldStatusClassInternal(d,a)}}else{var d=this.fields[b].object;this.setFieldStatusClassInternal(d,a)}}}},setFieldStatusClassInternal:function(c,a){var b=null;if(!(c instanceof NodeList)&&!(c instanceof HTMLCollection)&&!(c instanceof Array)){b=this.params.reflection;if(b!==null){var d=$(c).closest("."+b);if(d.length>0){c=d.get(0)}}}$(c).removeClass(this.params.reflectionSuccess);$(c).removeClass(this.params.reflectionWarning);$(c).removeClass(this.params.reflectionError);switch(a){case 0:$(c).addClass(this.params.reflectionError);break;case 1:$(c).addClass(this.params.reflectionWarning);break;case 2:$(c).addClass(this.params.reflectionSuccess);break}},applyPlaceholder:function(b,a){if(nabu.getNavigatorName()==="MSIE"){if(b.attributes.placeholder){var c=b.attributes.placeholder.value;if(a){$(b).removeClass("placeholder");if(b.value===c){b.value="";b.focus()}}else{if(b.value.length===0||b.value===c){b.value=c;$(b).addClass("placeholder")}else{$(b).removeClass("placeholder")}}}}},addAction:function(g,a,h,d){if(this.fields[g]){var b={status:a,target:h,action:d,loop:0};if(this.fields[g].actions===null){this.fields[g].actions=new Array();this.fields[g].actions.push(b)}else{for(var c=0;c<this.fields[g].actions.length;c++){if(this.fields[g].actions[c].status===a&&this.fields[g].actions[c].target===h){this.fields[g].actions.splice(c,1);break}}this.fields[g].actions.push(b)}this.resetActionsFlag();this.applyActionsForField(g);this.validateSameFields(g);this.validateForm()}},addActions:function(b){if(b!==null&b.length>0){for(var a in b){this.addAction(b[a][0],b[a][1],b[a][2],b[a][3])}}},resetActionsFlag:function(){this.maskActions.id=new Array();this.maskActions.name=new Array()},maskAction:function(d,c,h,b){var a=null;if(this.fields[d]){if(!this.maskActions.name[d]){this.maskActions.name[d]={visible:null,enabled:null}}if(h!==null){this.maskActions.name[d].visible=(this.maskActions.name[d].visible===null?h:this.maskActions.name[d].visible&h)}if(b!==null){this.maskActions.name[d].enabled=(this.maskActions.name[d].enabled===null?b:this.maskActions.name[d].enabled&b)}a=this.maskActions.name[d]}else{if(document.getElementById(d)){if(!this.maskActions.id[d]){this.maskActions.id[d]={visible:null,enabled:null}}if(h!==null){this.maskActions.id[d].visible=(this.maskActions.id[d].visible===null?h:this.maskActions.id[d].visible&h)}if(b!==null){this.maskActions.id[d].enabled=(this.maskActions.id[d].enabled===null?b:this.maskActions.id[d].enabled&b)}a=this.maskActions.id[d]}}if(a!==null){if(c instanceof NodeList||c instanceof Array){for(var g=0;g<c.length;g++){this.applyMask(c[g],a)}}else{if(c instanceof HTMLCollection){for(var g=0;g<c.length;g++){this.applyMask(c.item(g),a)}}else{if(c!==null){this.applyMask(c,a)}}}}},applyMask:function(b,a){if(b!==null){if(a.enabled!==null){b.disabled=!a.enabled;if(!a.enabled){b.setAttribute("disabled","");$(b).addClass("disabled")}else{b.removeAttribute("disabled");$(b).removeClass("disabled")}}if(a.visible!==null){if(a.visible===true){$(b).removeClass("hidden");$(b).addClass("visible")}else{$(b).removeClass("visible");$(b).addClass("hidden")}}}},applyActionsForField:function(a){if(this.fields[a]&&this.fields[a].actions!==null){for(var b=0;b<this.fields[a].actions.length;b++){var d=this.fields[a].actions[b];if(d.loop===0){var h=d.status.split(":");var c=h===null?d.status:h[0];var g=(this.fields[d.target]?this.fields[d.target].object:document.getElementById(d.target));if(g&&g!==null){this.prependActionsForTarget(d);if(this.evalActions(c,a,d.status)){this.fields[a].actions[b].loop=1;h=d.action.split(":");c=h===null?d.action:h[0];this.applyActions(c,d,g);if(this.fields[d.target]){this.applyActionsForField(d.target)}this.fields[a].actions[b].loop=0}}}}}},applyActions:function(a,b,c){switch(a){case"hidden":this.applyHiddenAction(b.target,c);break;case"visible":this.applyVisibleAction(b.target,c);break;case"disabled":this.applyDisabledAction(b.target,c);break;case"enabled":this.applyEnabledAction(b.target,c);break;case"javascript":this.applyJavascriptAction(b);break;case"none":break;default:alert("Unkown action '"+a+"'");return}},applyHiddenAction:function(b,a){if(a!==null){this.maskAction(b,a,false,null)}},applyVisibleAction:function(b,a){if(a!==null){this.maskAction(b,a,true,null)}},applyDisabledAction:function(b,a){if(a!==null){this.maskAction(b,a,null,false)}},applyEnabledAction:function(b,a){if(a!==null){this.maskAction(b,a,null,true)}},applyJavascriptAction:function(action){var p=action.action.indexOf(":");if(p>=0){var js=action.action.substr(p+1);window.eval(js)}},evalActions:function(c,b,a){var d=this.isAvailableField(b);switch(c){case"unselected":return d?this.evalUnselectedAction(b):true;case"selected":return d?this.evalSelectedAction(b):true;case"value":return d?this.evalValueAction(b,a):true;case"valid":return d?this.evalValidAction(b):true;case"invalid":return d?!this.evalValidAction(b):false;case"checked":return d?this.evalCheckedAction(b):true;case"unchecked":return d?!this.evalCheckedAction(b):false;case"filled":return d?!this.evalFilledAction(b):true;case"empty":return d?!this.evalEmptyAction(b):false}throw"Unkown status ["+c+"]";return false},prependActionsForTarget:function(g){var k=false;for(var c in this.fields){if(this.fields[c].actions!==null&&this.fields[c].actions.length>0){for(var b=0;b<this.fields[c].actions.length;b++){var a=this.fields[c].actions[b];if(a.target===g.target&&(a.status!==g.status||a.action!==g.action)){var h=g.status.split(":");var d=h===null?g.status:h[0];if(this.evalActions(d,c,a.status)){k=true;h=a.action.split(":");d=h===null?a.action:h[0]}}}}}return k},evalUnselectedAction:function(a){if(this.fields[a].object.tagName.toLowerCase()==="select"&&this.fields[a].object.attributes["data-unselected-value"]){var c=this.fields[a].object.attributes["data-unselected-value"].value;var b=this.fields[a].object.options[this.fields[a].object.selectedIndex].value;return c===b}return false},evalSelectedAction:function(a){if(this.fields[a].object.tagName.toLowerCase()==="select"&&this.fields[a].object.attributes["data-unselected-value"]){var c=this.fields[a].object.attributes["data-unselected-value"].value;var b=this.fields[a].object.options[this.fields[a].object.selectedIndex].value;return c!==b}return false},evalValueAction:function(c,a){var h=a.indexOf(":");if(h>=0){var b=a.substr(h+1);var g=this.getFieldValue(c);if(g instanceof Array){for(var d=0;d<g.length;d++){if(g[d]===b){return true}}return false}else{return(g!==null&&g===b)}}return false},evalValidAction:function(a){return this.fields[a]?(this.fields[a].trigger>0):true},evalCheckedAction:function(a){return this.fields[a]&&this.fields[a].object!==null&&this.fields[a].object.checked!==undefined?this.fields[a].object.checked:true},evalEmptyAction:function(a){var c=this.getFieldValue(a);if(c instanceof Array){for(var b=0;b<c.length;b++){if(c[b].length===0){return false}}return false}else{return !(c===null||c.length===0)}return true},evalFilledAction:function(a){var c=this.getFieldValue(a);if(c instanceof Array){for(var b=0;b<c.length;b++){if(c[b].length>0){return true}}return false}else{return(c!==null&&c.length>0)}return false},reset:function(){this.form.reset();if(this.fields!==null&&this.fields.length>0){for(var a in this.fields){this.evaluateField(a)}}this.validateForm()},refresh:function(){this.form.submit()},trigger:function(c){if(c!==null&&c.attributes.action){var a=c.attributes.action.value;var b=a.split(":");if(b!==null&&b.length>0){switch(b[0]){case"javascript":this.triggerJavascript(c,a);break;case"url":this.triggerHTTP(c,a);break}}}},triggerJavascript:function(obj,action){var p=action.indexOf(":");if(p>=0){var js=action.substr(p+1);eval(js)}},triggerHTTP:function(d,b){var c=b.indexOf(":");if(c>=0){var a=b.substr(c+1);document.location=a}},submitByAjax:function(s){var n,r="";var g=this;if(this.form!==null&&this.params.ajax===true){if(this.params.ajax_target!==null){var m=document.getElementById(this.params.ajax_target);if(m){$(m).addClass("sending")}else{$(this.form).addClass("sending")}}else{$(this.form).addClass("sending")}var q="application/x-www-form-urlencoded";if(this.params.enctype){q=this.params.enctype}else{if(this.form.encoding){q=this.form.encoding}else{if(this.form.contentType){q=this.form.enctype}}}var k=(q==="multipart/form-data");var v=(q==="application/json"||q==="text/json");if(k){var c=new FormData();for(n in this.fields){var m=this.fields[n].object;if(m!==null){if(m instanceof HTMLInputElement){if(m.attributes.type){var u=m.attributes.type.value;if(u==="file"){var b=(m.final_files?m.final_files:m.files);if(b.length==1){f.append(n,b[0])}else{for(var h=0;h<b.length;h++){c.append(n+"["+h+"]",b[h])}}}else{if(u!=="submit"&&u!=="image"){if((u!=="checkbox"&&u!=="radio")||m.checked){c.append(n,this.getFieldValue(n))}}}}}else{if(m instanceof HTMLSelectElement||m instanceof HTMLTextAreaElement||m instanceof NodeList||m instanceof HTMLCollection||m instanceof Array){c.append(n,this.getFieldValue(n))}else{if(!(m instanceof HTMLButtonElement)){throw"Object not found ["+m+" "+n+"]"}}}}}if((typeof s!=="undefined")&&s!==null&&s.attributes&&s.attributes.name){c.append(s.attributes.name.value,null)}}else{for(n in this.fields){var p=this.fields[n];var m=p.object;if(m!==null){if(m instanceof HTMLInputElement){if(m.attributes.type){var u=m.attributes.type.value;if(u!=="submit"&&u!=="image"){r+=(r.length===0?"":"&")+n+"="+encodeURIComponent(this.getFieldValue(n))}}}else{if(m instanceof HTMLSelectElement||m instanceof HTMLTextAreaElement||m instanceof NodeList||m instanceof HTMLCollection||m instanceof Array){r+=(r.length===0?"":"&")+n+"="+encodeURIComponent(this.getFieldValue(n))}else{if(!(m instanceof HTMLButtonElement)){throw"Object not found ["+m+" "+n+"]"}}}}}if(s!==undefined&&s!==null&&s.attributes&&s.attributes.name){r+=(r.length===0?"":"&")+s.attributes.name.value+"="}}var l=$(this.form).data();var d=(s.attributes&&s.attributes.formaction)?(s.attributes.formaction.value):(l.actionTemplate&&l.actionTemplate.length>0?((l.id)?$.sprintf(l.actionTemplate,l.id):$.sprintf(l.actionTemplate,"")):this.form.action);var a=l.ajaxMethod?l.ajaxMethod:this.form.method.toUpperCase();if(a==="GET"){d+=(d!==null&&d.indexOf("?")>=0?"&":"?")+r}var o=new Nabu.Ajax.Connector(d,a,{withCredentials:true,contentType:(k?null:q)});o.addEventListener(new Nabu.Event({onLoad:function(j){if(l.ajaxTarget){var t=document.getElementById(l.ajaxTarget);if(t){$(t).removeClass("sending");t.innerHTML=j.params.text;nabu.callJavaScript(t)}}if(l.ajaxOnload){window[g.params.ajax_onload]({form:g,response:j})}$(g.form).removeClass("sending");g.events.fireEvent("onSubmit",g,{response:j.params})},onError:function(){var j=document.getElementById(l.ajaxTarget);if(j){$(j).removeClass("sending")}g.events.fireEvent("onError",g)},onUploadProgress:function(j,t){if(g.params.ajax_on_upload_progress!==null){window[g.params.ajax_on_upload_progress]({form:g,response:t})}}}));if(k){o.setPostStream(c)}else{o.setPostStream(r)}o.execute()}},getSubmitButton:function(c){var a=this.submit_object!==null?this.submit_object:(c.explicitOriginalTarget?c.explicitOriginalTarget:null);if(a===null||(a.attributes.type&&a.attributes.type.value!=="submit")){for(var b in this.fields){var b=this.fields[b].object;if(b.attributes){if((b.attributes.type&&b.attributes.type.value==="submit")||(b.attributes.action&&b.attributes.action.value==="submit")){a=b;break}}}}return a},onSubmit:function(d){if(this.events.isEventTargeted("onBeforeSubmit")){this.events.fireEvent("onBeforeSubmit",this)}if(this.formaction!==null&&nabu.getNavigatorName()==="MSIE"){this.form.action=this.formaction}this.formaction=null;var a=this.getSubmitButton(d);if(this.params.ajax===true){this.submitByAjax(a);d.stopPropagation();return false}else{var c=$(this.form).data();var b=(a.attributes&&a.attributes.formaction)?(a.attributes.formaction.value):(c.actionTemplate&&c.actionTemplate.length>0?((c.id)?$.sprintf(c.actionTemplate,c.id):$.sprintf(c.actionTemplate,"")):this.form.action);$(this.form).attr("action",b);$(this.container).addClass("sending");return true}},onChangeField:function(c){var b=c.target;var a=this.validateField(b.name);this.setFieldStatusClass(b.name,a);this.resetActionsFlag();this.applyActionsForField(b.name);if(b.attributes.refresh&&b.attributes.refresh.value==="yes"){this.refresh();a=0}else{this.validateSameFields(b.name);this.validateForm()}this.events.fireEvent("onFieldChange",this,{field:b.name,value:$(b).val()});return(a!==0)},onFocusField:function(b){var a=b.target;this.applyPlaceholder(a,true)},onBlurField:function(c){var b=c.target;var a=this.validateField(b.name);this.setFieldStatusClass(b.name,a);this.resetActionsFlag();this.applyActionsForField(b.name);this.validateSameFields(b.name);this.validateForm();this.applyPlaceholder(b,false);return(a!==0)},onClickField:function(d){var c=d.target;if(!c.inClickForm){c.inClickForm=true;if(c.attributes.type&&c.attributes.type.value.toLowerCase()==="submit"){this.submit_object=c}var b=this.validateField(c.name);this.setFieldStatusClass(c.name,b);this.resetActionsFlag();this.applyActionsForField(c.name);if(b!==0){if(c.attributes.action){this.trigger(c)}}if(c.attributes.formaction){this.formaction=c.attributes.formaction.value}this.validateSameFields(c.name);this.validateForm();if(c.attributes.type){var a=c.attributes.type.value.toLowerCase();if(a==="checkbox"){this.events.fireEvent("onFieldChange",this,{field:c.name,value:c.checked?$(c).val():$(c).data("valueUnchecked")})}}c.inClickForm=false}return true},onKeyUp:function(c){var b=c.target;var a=this.validateField(b.name);this.setFieldStatusClass(b.name,a);this.resetActionsFlag();this.applyActionsForField(b.name);if(b.attributes.refresh&&b.attributes.refresh.value==="yes"){this.refresh();return false}this.validateSameFields(b.name);this.validateForm();return(a!==0)}};nabu.registerLibrary("Form",["Event","Ajax"]);