try{if(!Nabu)throw"Nabu Manager not loaded"}catch(e){throw"Nabu Manager not loaded"}void 0===Nabu.UI&&(Nabu.UI=function(){}),Nabu.UI.Form=function(e,t){this.events=new Nabu.EventPool,this.container=e,this.params=t,this.form=null,this.fields=new Array,this.formaction=null,this.maskActions={id:null,name:null},this.submit_object=null,this.validate=!0,this.sending=!1,this.init()},Nabu.UI.Form.prototype={addEventListener:function(e){this.events.addEventListener(e)},removeEventListener:function(e){this.events.removeEventListener(e)},init:function(e){var t=this,i=null;"FORM"===this.container.tagName?i=this.container:$(this.container).find("form").length>0?i=$(this.container).find("form").get(0):$(this.container).closest("form").length>0&&(i=$(this.container).closest("form").get(0)),void 0===e&&(e=!1),i&&(this.form=i,i.nabuForm=this,e||$(i).on("submit",function(e){return t.onSubmit(e.originalEvent)}),this.locateFields(e),this.validateForm(),e||setTimeout(function(){t.init(!0)},1e3))},locateFields:function(e){for(var t in this.form.elements){var i=null;if("attributes"!==t&&"elements"!==t&&"childNodes"!==t&&"children"!==t&&"properties"!==t&&"all"!==t){var a=this.form[t];if(null!==a&&""!==a&&!0!==a&&"object"==typeof a&&(a instanceof Element||a instanceof NodeList||a instanceof HTMLCollection)&&(a instanceof HTMLInputElement||a instanceof HTMLSelectElement||a instanceof HTMLTextAreaElement?i=a:a instanceof HTMLButtonElement?i=a:a instanceof NodeList?i=a:a instanceof HTMLCollection&&(i=a),null!==i)){var n=a.name&&a.name.length>0?a.name:t;!0!==e&&(a.nabuForm=!1),this.appendField(n,a)}}}},appendField:function(e,t){var i,a=!1;if(t instanceof NodeList)for(i=0;i<t.length;i++)t.nabuForm||(this.connectFieldObject(t[i]),a=!0);else if(t instanceof HTMLCollection)for(i=0;i<t.length;i++)t.nabuForm||(this.connectFieldObject(t.item(i)),a=!0);else t.nabuForm||(this.connectFieldObject(t),a=!0);if(!0===a){if(this.fields[e]?this.fields[e].object instanceof Array?this.fields[e].object.indexOf(t)<0&&this.fields[e].object.push(t):this.fields[e].object!==t&&(this.fields[e].object=[this.fields[e].object],this.fields[e].object.indexOf(t)<0&&this.fields[e].object.push(t)):this.fields[e]={object:t,trigger:3,actions:null,touched:!1,visible:!0,enabled:!0},!(t instanceof HTMLButtonElement||t instanceof HTMLInputElement&&("button"===t.type||"submit"===t.type||"image"===t.type))){var n=this.validateField(e);this.setFieldStatusClass(e,n)}this.resetActionsFlag(),this.applyActionsForField(e),this.validateSameFields(e),this.validateForm()}},connectFieldObject:function(e){var t=this;if(e.nabuForm=this,e instanceof HTMLSelectElement)$(e).on("change",function(e){return t.onChangeField(e.originalEvent)});else if(e instanceof HTMLInputElement){var i=e.type.toLowerCase();switch(i){case"text":case"number":case"date":case"time":case"datetime":case"email":case"password":case"file":$(e).on("change",function(e){return t.onChangeField(e.originalEvent?e.originalEvent:e)}).on("blur",function(e){return t.onBlurField(e.originalEvent?e.originalEvent:e)}).on("focus",function(e){return t.onFocusField(e.originalEvent?e.originalEvent:e)}),this.applyPlaceholder(e,!1);break;case"button":case"submit":case"image":case"checkbox":$(e).on("click",function(e){return t.onClickField(e.originalEvent?e.originalEvent:e)});break;case"radio":$(e).on("click",function(e){return t.onClickField(e.originalEvent?e.originalEvent:e)}),e.checked&&$(e.parentElement).addClass(this.active_class);break;case"hidden":$(e).on("change",function(e){return t.onChangeField(e.originalEvent?e.originalEvent:e)});break;default:$(e).on("blur",function(e){return t.onBlurField(e.originalEvent?e.originalEvent:e)})}"live"===this.params.validation&&$(e).on("keyup",function(e){return t.onKeyUp(e.originalEvent?e.originalEvent:e)})}else e instanceof HTMLTextAreaElement?($(e).on("change",function(e){return t.onChangeField(e.originalEvent?e.originalEvent:e)}).on("blur",function(e){return t.onBlurField(e.originalEvent?e.originalEvent:e)}).on("focus",function(e){return t.onFocusField(e.originalEvent?e.originalEvent:e)}),"live"===this.params.validation&&$(e).on("keyup",function(e){return t.onKeyUp(e.originalEvent?e.originalEvent:e)})):e instanceof HTMLButtonElement?$(e).on("click",function(e){return t.onClickField(e.originalEvent?e.originalEvent:e)}):$(e).on("blur",function(e){return t.onBlurField(e.originalEvent?e.originalEvent:e)})},isAvailableField:function(e){var t="visible"!==this.params.evaluate;if(this.fields[e])if(this.fields[e].object instanceof NodeList||this.fields[e].object instanceof Array)for(var i in this.fields[e].object)t=t||nabu.isObjectVisible(this.fields[e].object[i].parentElement);else if(this.fields[e].object instanceof HTMLCollection)for(var a=0;a<this.fields[e].object.length;a++)t=t||nabu.isObjectVisible(this.fields[e].object.item(a).parentElement);else t=t||nabu.isObjectVisible(this.fields[e].object.parentElement);return t},getFieldValue:function(e){var t=null;if(this.fields[e]){var i=this.fields[e];if(i.object instanceof NodeList||i.object instanceof Array){t=new Array;for(var a=0;a<i.object.length;a++)(i.object[a].checked||i.object[a].selected)&&t.push(i.object[a].value);0===t.length?t=null:1===t.length&&(t=t.shift())}else if(i.object instanceof HTMLCollection){t=new Array;for(var a=0;a<i.object.length;a++)(i.object.item(a).checked||i.object.item(a).selected)&&t.push(i.object.item(a).value);0===t.length?t=null:1===t.length&&(t=t.shift())}else i.object instanceof HTMLSelectElement?i.object.selectedIndex>-1&&(t=i.object[i.object.selectedIndex].value):(i.object instanceof HTMLInputElement||i.object instanceof HTMLTextAreaElement)&&(t=i.object.attributes.type&&"radio"===i.object.attributes.type.value&&i.object.attributes.name&&null!==this.form?this.getRadioValue(this.form[i.object.attributes.name.value],null):i.object.attributes.type&&"checkbox"===i.object.attributes.type.value&&!i.object.checked?$(i.object).data("valueUnchecked"):i.object.value,"MSIE"===nabu.getNavigatorName()&&i.object.attributes.placeholder&&i.object.attributes.placeholder===t&&(t=""))}return t},getRadioValue:function(e,t){for(i=0;i<e.length;i++)if(e[i].checked)return e[i].value;return t},evaluateField:function(e,t){var i=!0;return this.fields[e]&&(i=this.validateField(e,t),this.setFieldStatusClass(e,i),this.resetActionsFlag(),this.applyActionsForField(e),this.validateSameFields(e),this.validateForm(),0===i&&(i=!1)),i},fieldFollowsForm:function(e,t,i){if(null===e)return!0;switch(t){case"active":this.applyMask(e,{enabled:i,visible:null});break;case"visible":this.applyMask(e,{enabled:null,visible:i});break;default:throw"Unknown data-form-follow type ["+t+"]"}return!0},validateField:function(e,t){var i=3;if(void 0===t&&(t=!1),this.fields[e]){if(!1===t){if(this.fields[e].object instanceof NodeList||this.fields[e].object instanceof Array){i=0;for(var a=0;a<this.fields[e].object.length;a++){var n=this.fields[e].object[a],s=this.validateFieldPart(n);s>i&&(i=s)}}else if(this.fields[e].object instanceof HTMLCollection){i=0;for(var a=0;a<this.fields[e].object.length;a++){var n=this.fields[e].object.item(a),s=this.validateFieldPart(n);s>i&&(i=s)}}else{var n=this.fields[e].object;i=this.validateFieldPart(n)}i=this.events.fireEvent("onValidateField",this,{name:e,status:i},i)}else i=this.events.fireEvent("onValidateField",this,{name:e,status:t},i);this.fields[e].trigger=i}return i},validateFieldPart:function(e){var t=this,i=3,a=e.attributes&&e.attributes["data-form-mandatory"]?e.attributes["data-form-mandatory"].value:"none",n=e.attributes&&e.attributes["data-form-rule"]?e.attributes["data-form-rule"].value:"none",s=e.attributes&&e.attributes["data-form-rule-param"]?e.attributes["data-form-rule-param"].value:null,l=e.value;if("MSIE"===nabu.getNavigatorName()&&e.attributes.placeholder&&e.attributes.placeholder.value===l&&(l=""),"none"!==n){i="yes"===a?0:0===l.length?1:0;var o=n.split(":");switch(null===o?n:o[0]){case"filled":l.length>0&&(!e.attributes["data-unselected-value"]||e.attributes["data-unselected-value"].value!==l)&&(i=2);break;case"regex":l.length>0&&null!==(o=RegExp("("+s+")").exec(l))&&o.length>=2&&o[1].length===l.length&&(i=2);break;case"uri":if(2===o.length)switch(o[1]){case"web":nabu.isValidURL(l)&&(i=2);break;case"email":nabu.isValidEmail(l)&&(i=2);break;case"ipv4":nabu.isValidIPv4(l)&&(i=2);break;case"phone":nabu.isValidPhoneNumber(l)&&(i=2)}break;case"same":if(2===o.length){var r=this.getFieldValue(o[1]);i=null!==r&&!1!==r&&""!==r||null!==l&&!1!==l&&""!==l?r===l?2:0:"yes"===a?0:1}break;case"checked":e instanceof NodeList||e instanceof HTMLCollection||e instanceof Array||!e.checked||!0!==e.checked||(i=2);break;case"unchecked":e instanceof NodeList||e instanceof HTMLCollection||e instanceof Array||!e.checked||!0===e.checked||(i=2);break;case"groupcheck":e instanceof HTMLInputElement&&"checkbox"==e.attributes.type.value&&3===o.length&&(i=$('[data-form-rule="'+n+'"]:checked').length>=o[2]?2:0,e.formValidationLock=!0,$('[data-form-rule="'+n+'"]').each(function(){this.formValidationLock||t.evaluateField(this.attributes.name.value,i)}),e.formValidationLock=!1)}}return i},validateSameFields:function(e){var t;for(var i in this.fields)if(i!==e){t=this.fields[i];var a=t.object.attributes&&t.object.attributes["data-form-rule"]?t.object.attributes["data-form-rule"].value:"none";if(null!==a&&"none"!==a){var n=a.split(":");null!==n&&2===n.length&&"same"===n[0]&&n[1]===e&&this.evaluateField(i)}}},validateForm:function(){if(null!==this.fields){this.validate=!0;for(var e in this.fields){var t=this.fields[e];if(0===t.trigger)if(t.object instanceof NodeList||t.object instanceof Array)for(i=0;i<t.object.length;i++)this.isAvailableField(e)&&!t.object[i].disabled&&(this.validate=!1);else if(t.object instanceof HTMLCollection)for(i=0;i<t.object.length;i++)this.isAvailableField(e)&&!t.object.item(i).disabled&&(this.validate=!1);else this.isAvailableField(e)&&!t.object.disabled&&(this.validate=!1)}for(e in this.fields){t=this.fields[e];var a=!1;if(t.object instanceof NodeList||t.object instanceof Array)for(i=0;i<t.object.length;i++)t.object[i].attributes&&null!==t.object[i].attributes&&t.object[i].attributes["data-form-follow"]&&this.isAvailableField(e)&&this.fieldFollowsForm(t.object[i],t.object[i].attributes["data-form-follow"].value,this.validate);else if(t.object instanceof HTMLCollection)for(i=0;i<t.object.length;i++)t.object.item(i).attributes&&null!==t.object.item(i).attributes&&t.object.item(i).attributes["data-form-follow"]&&this.isAvailableField(e)&&this.fieldFollowsForm(t.object.item(i),t.object.item(i).attributes["data-form-follow"].value,this.validate);else t.object.hasAttribute("type")&&"submit"==t.object.getAttribute("type").toLowerCase()&&(a=!0,t.object.removeAttribute("disabled"),$(t.object).removeClass("disabled")),null!==t.object.attributes&&t.object.attributes["data-form-follow"]&&this.isAvailableField(e)&&this.fieldFollowsForm(t.object,t.object.attributes["data-form-follow"].value,this.validate);this.sending&&a&&(t.object.setAttribute("disabled","disabled"),$(t.object).addClass("disabled"))}return this.validate}return!1},setFieldStatusClass:function(e,t){if(this.fields[e])if(this.fields[e].object instanceof NodeList||this.fields[e].object instanceof Array)for(var i=0;i<this.fields[e].object.length;i++){var a=this.fields[e].object[i];this.setFieldStatusClassInternal(a,t)}else if(this.fields[e].object instanceof HTMLCollection)for(var i=0;i<this.fields[e].object.length;i++){var a=this.fields[e].object.item(i);this.setFieldStatusClassInternal(a,t)}else{var a=this.fields[e].object;this.setFieldStatusClassInternal(a,t)}},setFieldStatusClassInternal:function(e,t){var i=null;if(!(e instanceof NodeList||e instanceof HTMLCollection||e instanceof Array)&&null!==(i=this.params.reflection)){var a=$(e).closest("."+i);a.length>0&&(e=a.get(0))}switch($(e).removeClass(this.params.reflectionSuccess),$(e).removeClass(this.params.reflectionWarning),$(e).removeClass(this.params.reflectionError),t){case 0:$(e).addClass(this.params.reflectionError);break;case 1:$(e).addClass(this.params.reflectionWarning);break;case 2:$(e).addClass(this.params.reflectionSuccess)}},applyPlaceholder:function(e,t){if("MSIE"===nabu.getNavigatorName()&&e.attributes.placeholder){var i=e.attributes.placeholder.value;t?($(e).removeClass("placeholder"),e.value===i&&(e.value="",e.focus())):0===e.value.length||e.value===i?(e.value=i,$(e).addClass("placeholder")):$(e).removeClass("placeholder")}},addAction:function(e,t,i,a){if(this.fields[e]){var n={status:t,target:i,action:a,loop:0};if(null===this.fields[e].actions)this.fields[e].actions=new Array,this.fields[e].actions.push(n);else{for(var s=0;s<this.fields[e].actions.length;s++)if(this.fields[e].actions[s].status===t&&this.fields[e].actions[s].target===i){this.fields[e].actions.splice(s,1);break}this.fields[e].actions.push(n)}this.resetActionsFlag(),this.applyActionsForField(e),this.validateSameFields(e),this.validateForm()}},addActions:function(e){if(null!==e&e.length>0)for(var t in e)this.addAction(e[t][0],e[t][1],e[t][2],e[t][3])},resetActionsFlag:function(){this.maskActions.id=new Array,this.maskActions.name=new Array},maskAction:function(e,t,i,a){var n=null;if(this.fields[e]?(this.maskActions.name[e]||(this.maskActions.name[e]={visible:null,enabled:null}),null!==i&&(this.maskActions.name[e].visible=null===this.maskActions.name[e].visible?i:this.maskActions.name[e].visible&i),null!==a&&(this.maskActions.name[e].enabled=null===this.maskActions.name[e].enabled?a:this.maskActions.name[e].enabled&a),n=this.maskActions.name[e]):document.getElementById(e)&&(this.maskActions.id[e]||(this.maskActions.id[e]={visible:null,enabled:null}),null!==i&&(this.maskActions.id[e].visible=null===this.maskActions.id[e].visible?i:this.maskActions.id[e].visible&i),null!==a&&(this.maskActions.id[e].enabled=null===this.maskActions.id[e].enabled?a:this.maskActions.id[e].enabled&a),n=this.maskActions.id[e]),null!==n)if(t instanceof NodeList||t instanceof Array)for(var s=0;s<t.length;s++)this.applyMask(t[s],n);else if(t instanceof HTMLCollection)for(var s=0;s<t.length;s++)this.applyMask(t.item(s),n);else null!==t&&this.applyMask(t,n)},applyMask:function(e,t){null!==e&&(null!==t.enabled&&(e.disabled=!t.enabled,t.enabled?(e.removeAttribute("disabled"),$(e).removeClass("disabled")):(e.setAttribute("disabled",""),$(e).addClass("disabled"))),null!==t.visible&&(!0===t.visible?($(e).removeClass("hidden"),$(e).addClass("visible")):($(e).removeClass("visible"),$(e).addClass("hidden"))))},applyActionsForField:function(e){if(this.fields[e]&&null!==this.fields[e].actions)for(var t=0;t<this.fields[e].actions.length;t++){var i=this.fields[e].actions[t];if(0===i.loop){var a=i.status.split(":"),n=null===a?i.status:a[0],s=this.fields[i.target]?this.fields[i.target].object:document.getElementById(i.target);s&&null!==s&&(this.prependActionsForTarget(i),this.evalActions(n,e,i.status)&&(this.fields[e].actions[t].loop=1,a=i.action.split(":"),n=null===a?i.action:a[0],this.applyActions(n,i,s),this.fields[i.target]&&this.applyActionsForField(i.target),this.fields[e].actions[t].loop=0))}}},applyActions:function(e,t,i){switch(e){case"hidden":this.applyHiddenAction(t.target,i);break;case"visible":this.applyVisibleAction(t.target,i);break;case"disabled":this.applyDisabledAction(t.target,i);break;case"enabled":this.applyEnabledAction(t.target,i);break;case"javascript":this.applyJavascriptAction(t);break;case"none":break;default:return void alert("Unkown action '"+e+"'")}},applyHiddenAction:function(e,t){null!==t&&this.maskAction(e,t,!1,null)},applyVisibleAction:function(e,t){null!==t&&this.maskAction(e,t,!0,null)},applyDisabledAction:function(e,t){null!==t&&this.maskAction(e,t,null,!1)},applyEnabledAction:function(e,t){null!==t&&this.maskAction(e,t,null,!0)},applyJavascriptAction:function(e){var t=e.action.indexOf(":");if(t>=0){var i=e.action.substr(t+1);window.eval(i)}},evalActions:function(e,t,i){var a=this.isAvailableField(t);switch(e){case"unselected":return!a||this.evalUnselectedAction(t);case"selected":return!a||this.evalSelectedAction(t);case"value":return!a||this.evalValueAction(t,i);case"valid":return!a||this.evalValidAction(t);case"invalid":return!!a&&!this.evalValidAction(t);case"checked":return!a||this.evalCheckedAction(t);case"unchecked":return!!a&&!this.evalCheckedAction(t);case"filled":return!a||!this.evalFilledAction(t);case"empty":return!!a&&!this.evalEmptyAction(t)}throw"Unkown status ["+e+"]"},prependActionsForTarget:function(e){var t=!1;for(var i in this.fields)if(null!==this.fields[i].actions&&this.fields[i].actions.length>0)for(var a=0;a<this.fields[i].actions.length;a++){var n=this.fields[i].actions[a];if(n.target===e.target&&(n.status!==e.status||n.action!==e.action)){var s=e.status.split(":"),l=null===s?e.status:s[0];this.evalActions(l,i,n.status)&&(t=!0,s=n.action.split(":"),l=null===s?n.action:s[0])}}return t},evalUnselectedAction:function(e){if("select"===this.fields[e].object.tagName.toLowerCase()&&this.fields[e].object.attributes["data-unselected-value"]){return this.fields[e].object.attributes["data-unselected-value"].value===this.fields[e].object.options[this.fields[e].object.selectedIndex].value}return!1},evalSelectedAction:function(e){if("select"===this.fields[e].object.tagName.toLowerCase()&&this.fields[e].object.attributes["data-unselected-value"]){return this.fields[e].object.attributes["data-unselected-value"].value!==this.fields[e].object.options[this.fields[e].object.selectedIndex].value}return!1},evalValueAction:function(e,t){var i=t.indexOf(":");if(i>=0){var a=t.substr(i+1),n=this.getFieldValue(e);if(n instanceof Array){for(var s=0;s<n.length;s++)if(n[s]===a)return!0;return!1}return null!==n&&n===a}return!1},evalValidAction:function(e){return!this.fields[e]||this.fields[e].trigger>0},evalCheckedAction:function(e){return!this.fields[e]||null===this.fields[e].object||void 0===this.fields[e].object.checked||this.fields[e].object.checked},evalEmptyAction:function(e){var t=this.getFieldValue(e);if(t instanceof Array){for(var i=0;i<t.length;i++)if(0===t[i].length)return!1;return!1}return!(null===t||0===t.length)},evalFilledAction:function(e){var t=this.getFieldValue(e);if(t instanceof Array){for(var i=0;i<t.length;i++)if(t[i].length>0)return!0;return!1}return null!==t&&t.length>0},reset:function(){if(this.form.reset(),null!==this.fields&&this.fields.length>0)for(var e in this.fields)this.evaluateField(e);this.validateForm()},refresh:function(){this.form.submit()},trigger:function(e){if(null!==e&&e.attributes.action){var t=e.attributes.action.value,i=t.split(":");if(null!==i&&i.length>0)switch(i[0]){case"javascript":this.triggerJavascript(e,t);break;case"url":this.triggerHTTP(e,t)}}},triggerJavascript:function(obj,action){var p=action.indexOf(":");if(p>=0){var js=action.substr(p+1);eval(js)}},triggerHTTP:function(e,t){var i=t.indexOf(":");if(i>=0){var a=t.substr(i+1);document.location=a}},submitByAjax:function(e){var t,i="",a=this;if(null!==this.form&&!0===this.params.ajax){if(null!==this.params.ajax_target){var n=document.getElementById(this.params.ajax_target);n?$(n).addClass("sending"):$(this.form).addClass("sending")}else $(this.form).addClass("sending");var s="application/x-www-form-urlencoded";this.params.enctype?s=this.params.enctype:this.form.encoding?s=this.form.encoding:this.form.contentType&&(s=this.form.enctype);var l="multipart/form-data"===s,o="application/json"===s||"text/json"===s;if(l){var r=new FormData;for(t in this.fields){var n=this.fields[t].object;if(null!==n)if(n instanceof HTMLInputElement){if(n.attributes.type){var c=n.attributes.type.value;if("file"===c){var d=n.final_files?n.final_files:n.files;if(1==d.length)r.append(t,d[0]);else for(var u=0;u<d.length;u++)r.append(t+"["+u+"]",d[u])}else"submit"!==c&&"image"!==c&&("checkbox"!==c&&"radio"!==c||n.checked)&&r.append(t,this.getFieldValue(t))}}else if(n instanceof HTMLSelectElement||n instanceof HTMLTextAreaElement||n instanceof NodeList||n instanceof HTMLCollection||n instanceof Array)r.append(t,this.getFieldValue(t));else if(!(n instanceof HTMLButtonElement))throw"Object not found ["+n+" "+t+"]"}void 0!==e&&null!==e&&e.attributes&&e.attributes.name&&r.append(e.attributes.name.value,null)}else if(o){var f={};for(t in this.fields){var n=this.fields[t].object;if(null!==n)if(n instanceof HTMLInputElement){if(n.attributes.type){var c=n.attributes.type.value;"file"===c?console.log('type="file" not supported in JSON mode'):"submit"!==c&&"image"!==c&&("checkbox"!==c&&"radio"!==c||n.checked)&&(f[t]=this.getFieldValue(t))}}else if(n instanceof HTMLSelectElement||n instanceof HTMLTextAreaElement||n instanceof NodeList||n instanceof HTMLCollection||n instanceof Array)f[t]=this.getFieldValue();else if(!(n instanceof HTMLButtonElement))throw"Object not found ["+n+" "+t+"]"}void 0!==e&&null!==e&&e.attributes&&e.attributes.name&&(f[e.attributes.name.value]=null),i=JSON.stringify(f)}else{for(t in this.fields){var h=this.fields[t],n=h.object;if(null!==n)if(n instanceof HTMLInputElement){if(n.attributes.type){var c=n.attributes.type.value;"submit"!==c&&"image"!==c&&(i+=(0===i.length?"":"&")+t+"="+encodeURIComponent(this.getFieldValue(t)))}}else if(n instanceof HTMLSelectElement||n instanceof HTMLTextAreaElement||n instanceof NodeList||n instanceof HTMLCollection||n instanceof Array)i+=(0===i.length?"":"&")+t+"="+encodeURIComponent(this.getFieldValue(t));else if(!(n instanceof HTMLButtonElement))throw"Object not found ["+n+" "+t+"]"}void 0!==e&&null!==e&&e.attributes&&e.attributes.name&&(i+=(0===i.length?"":"&")+e.attributes.name.value+"=")}var b=$(this.form).data(),v=e.attributes&&e.attributes.formaction?e.attributes.formaction.value:b.actionTemplate&&b.actionTemplate.length>0?b.id?$.sprintf(b.actionTemplate,b.id):$.sprintf(b.actionTemplate,""):this.form.action,m=b.ajaxMethod?b.ajaxMethod.toUpperCase():this.form.method.toUpperCase();"GET"===m&&(v+=(null!==v&&v.indexOf("?")>=0?"&":"?")+i);var p=new Nabu.Ajax.Connector(v,m,{withCredentials:!0,contentType:l?null:s});p.addEventListener(new Nabu.Event({onLoad:function(e){if(b.ajaxTarget){var t=document.getElementById(b.ajaxTarget);t&&($(t).removeClass("sending"),t.innerHTML=e.params.text,nabu.callJavaScript(t))}else $(a.form).removeClass("sending");b.ajaxOnload&&window[a.params.ajax_onload]({form:a,response:e}),a.events.fireEvent("onSubmit",a,{response:e.params}),a.sending=!1,a.validateForm()},onError:function(e){if(b.ajaxTarget){var t=document.getElementById(b.ajaxTarget);t&&($(t).removeClass("sending"),t.innerHTML=response.params.text,nabu.callJavaScript(t))}else $(a.form).removeClass("sending");a.events.fireEvent("onError",a,e.params),a.sending=!1,a.validateForm()},onUploadProgress:function(e,t){null!==a.params.ajax_on_upload_progress&&window[a.params.ajax_on_upload_progress]({form:a,response:t})}})),l?p.setPostStream(r):p.setPostStream(i),p.execute()}},getSubmitButton:function(e){var t=null!==this.submit_object?this.submit_object:e.explicitOriginalTarget?e.explicitOriginalTarget:null;if(null===t||t.attributes.type&&"submit"!==t.attributes.type.value)for(var i in this.fields){var i=this.fields[i].object;if(i.attributes&&(i.attributes.type&&"submit"===i.attributes.type.value||i.attributes.action&&"submit"===i.attributes.action.value)){t=i;break}}return t},onSubmit:function(e){if(!this.events.fireEvent("onBeforeSubmit",this,null,!0)||this.sending)return!1;this.sending=!0,this.validateForm(),null!==this.formaction&&"MSIE"===nabu.getNavigatorName()&&(this.form.action=this.formaction),this.formaction=null;var t=this.getSubmitButton(e);if(!0===this.params.ajax)return this.submitByAjax(t),e.stopPropagation(),!1;var i=$(this.form).data(),a=t.attributes&&t.attributes.formaction?t.attributes.formaction.value:i.actionTemplate&&i.actionTemplate.length>0?i.id?$.sprintf(i.actionTemplate,i.id):$.sprintf(i.actionTemplate,""):this.form.action;return $(this.form).attr("action",a),$(this.container).addClass("sending"),!0},onChangeField:function(e){var t=e.target,i=this.validateField(t.name);return this.setFieldStatusClass(t.name,i),this.resetActionsFlag(),this.applyActionsForField(t.name),t.attributes.refresh&&"yes"===t.attributes.refresh.value?(this.refresh(),i=0):(this.validateSameFields(t.name),this.validateForm()),this.events.fireEvent("onFieldChange",this,{field:t.name,value:$(t).val()}),0!==i},onFocusField:function(e){var t=e.target;this.applyPlaceholder(t,!0)},onBlurField:function(e){var t=e.target,i=this.validateField(t.name);return this.setFieldStatusClass(t.name,i),this.resetActionsFlag(),this.applyActionsForField(t.name),this.validateSameFields(t.name),this.validateForm(),this.applyPlaceholder(t,!1),0!==i},onClickField:function(e){var t=e.target;if(!t.inClickForm){t.inClickForm=!0,t.attributes.type&&"submit"===t.attributes.type.value.toLowerCase()&&(this.submit_object=t);var i=this.validateField(t.name);if(this.setFieldStatusClass(t.name,i),this.resetActionsFlag(),this.applyActionsForField(t.name),0!==i&&t.attributes.action&&this.trigger(t),t.attributes.formaction&&(this.formaction=t.attributes.formaction.value),this.validateSameFields(t.name),this.validateForm(),t.attributes.type){"checkbox"===t.attributes.type.value.toLowerCase()&&this.events.fireEvent("onFieldChange",this,{field:t.name,value:t.checked?$(t).val():$(t).data("valueUnchecked")})}t.inClickForm=!1}return!0},onKeyUp:function(e){var t=e.target,i=this.validateField(t.name);return this.setFieldStatusClass(t.name,i),this.resetActionsFlag(),this.applyActionsForField(t.name),t.attributes.refresh&&"yes"===t.attributes.refresh.value?(this.refresh(),!1):(this.validateSameFields(t.name),this.validateForm(),0!==i)}},nabu.registerLibrary("Form",["Event","Ajax"]);